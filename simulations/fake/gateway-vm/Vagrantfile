# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"
  config.vm.box_version = "4.3.12"
  config.vm.hostname = "gateway-vm"
  
  config.vm.network "public_network",
    dev: "wlan0",
    ip: "192.168.10.5",
    netmask: "255.255.255.0"
  
  config.vm.network "private_network",
    libvirt__network_name: "maya_internal",
    ip: "10.20.20.1"

  config.vm.provider :libvirt do |lv|
    lv.memory = 2048
    lv.cpus = 2
    lv.nic_model_type = "virtio"
    lv.cpu_mode = "host-model"
  end
  
  config.vm.provision "shell", inline: <<-SHELL
    set -e

    echo "[+] Installing base packages..."
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
      iptables-persistent tcpdump tshark net-tools docker.io

    echo "[+] Enabling IP forwarding..."
    grep -q net.ipv4.ip_forward /etc/sysctl.conf || \
      echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
    sysctl -p

    echo "[+] Detecting external interface..."
    EXT_IFACE=$(ip route | awk '/default/ {print $5; exit}')

    echo "[+] Configuring NAT..."
    iptables -t nat -C POSTROUTING -s 10.20.20.0/24 -o $EXT_IFACE -j MASQUERADE 2>/dev/null || \
    iptables -t nat -A POSTROUTING -s 10.20.20.0/24 -o $EXT_IFACE -j MASQUERADE

    iptables -C FORWARD -i $EXT_IFACE -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || \
    iptables -A FORWARD -i $EXT_IFACE -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT

    iptables -C FORWARD -i eth1 -o $EXT_IFACE -j ACCEPT 2>/dev/null || \
    iptables -A FORWARD -i eth1 -o $EXT_IFACE -j ACCEPT

    netfilter-persistent save

    echo "[+] Configuring Docker..."
    systemctl enable docker
    systemctl start docker
    usermod -aG docker vagrant

    echo "[+] Installing syslogd-helper..."
    cat > /usr/local/bin/syslogd-helper << 'EOF'
#!/bin/bash
case "$1" in
  stats)
    if [ -f /var/lib/.syscache ]; then
      cat /var/lib/.syscache
    else
      echo '{"attackers":{},"stolen_creds":{},"active_sessions":{}}'
    fi
    ;;
  *)
    echo "Usage: $0 {stats}"
    exit 1
    ;;
esac
EOF
    chmod +x /usr/local/bin/syslogd-helper

    echo "[+] Gateway VM configured successfully."
  SHELL
end